<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grafik Total Produk</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
</head>
<body style="font-family: Arial; padding: 20px;">
  <h2>Grafik Total Produk per Bulan</h2>
  <canvas id="chart" style="width:100%; height:420px"></canvas>

  <script>
    fetch('data.csv')
      .then(r => r.text())
      .then(text => parseCSV(text));

    function parseCSV(text) {
      // Perbaikan: regex baris
      const lines = text.trim().split(/\r?\n/);

      // Perbaikan: split otomatis koma atau titik koma
      const rows = lines.map(l => l.split(/[;,]/));

      // Temukan baris header bulan
      const monthRow = rows.find(r => r.some(c => c.trim() === 'Jan'));
      if (!monthRow) {
        alert('Tidak ditemukan header bulan JANâ€“DEC pada CSV');
        return;
      }

      const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

      // Buat mapping kolom
      const monthIndex = {};
      monthNames.forEach(m => monthIndex[m] = monthRow.indexOf(m));

      // Hitung total per bulan
      const totals = {};
      monthNames.forEach(m => totals[m] = 0);

      const startRow = rows.indexOf(monthRow) + 1;

      for (let r = startRow; r < rows.length; r++) {
        const row = rows[r];

        monthNames.forEach(m => {
          const col = monthIndex[m];
          if (col < 0 || !row[col]) return;

          let val = row[col].replace(/,/g,'.').trim();
          val = parseFloat(val);
          if (!isNaN(val)) totals[m] += val;
        });
      }

      drawChart(totals);
    }

    function drawChart(totals) {
      const labels = Object.keys(totals);
      const values = Object.values(totals);

      new Chart(document.getElementById('chart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Total Produk per Bulan',
            data: values,
            backgroundColor: labels.map(() =>
              `hsl(${Math.random()*360},70%,55%)`
            )
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>
</body>
</html>
